{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}QR Code Scanner | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
<style>
    .scanner-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .scanner-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .manual-input {
        margin: 20px 0;
    }
    
    .manual-input input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .result-section {
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        display: none;
    }
    
    .result-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .result-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .booking-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        padding: 3px 0;
    }
    
    .detail-label {
        font-weight: 600;
    }
    
    #video-container {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        text-align: center;
    }
    
    #video {
        width: 100%;
        border: 2px solid #ddd;
        border-radius: 5px;
    }
    
    .camera-controls {
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="scanner-container">
    <h1>QR Code Scanner</h1>
    <p>Scan QR codes to verify bookings</p>
    
    <div class="scanner-section">
        <h3>Camera Scanner</h3>
        <div id="video-container">
            <video id="video" autoplay></video>
        </div>
        <div class="camera-controls">
            <button id="start-camera" class="btn btn-primary">Start Camera</button>
            <button id="stop-camera" class="btn btn-danger" style="display: none;">Stop Camera</button>
        </div>
    </div>
    
    <div class="scanner-section">
        <h3>Manual Input</h3>
        <div class="manual-input">
            <input type="text" id="token-input" placeholder="Enter booking token manually">
            <button id="verify-token" class="btn btn-success">Verify Token</button>
        </div>
    </div>
    
    <div id="result-section" class="result-section">
        <h3>Verification Result</h3>
        <div id="result-content"></div>
    </div>
</div>

<script>
let stream = null;
let video = document.getElementById('video');
let startButton = document.getElementById('start-camera');
let stopButton = document.getElementById('stop-camera');
let tokenInput = document.getElementById('token-input');
let verifyButton = document.getElementById('verify-token');
let resultSection = document.getElementById('result-section');
let resultContent = document.getElementById('result-content');

// Camera controls
startButton.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
        });
        video.srcObject = stream;
        startButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
    } catch (err) {
        alert('Error accessing camera: ' + err.message);
    }
});

stopButton.addEventListener('click', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        startButton.style.display = 'inline-block';
        stopButton.style.display = 'none';
    }
});

// Manual verification
verifyButton.addEventListener('click', async () => {
    const token = tokenInput.value.trim();
    if (!token) {
        alert('Please enter a token');
        return;
    }
    
    await verifyBooking(token);
});

// Verify booking function
async function verifyBooking(token) {
    try {
        const response = await fetch(`/api/v1/bookings/verify/${token}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.valid) {
            showResult('success', data);
        } else {
            showResult('error', data);
        }
    } catch (err) {
        showResult('error', { message: 'Error verifying booking: ' + err.message });
    }
}

// Show result
function showResult(type, data) {
    resultSection.className = `result-section result-${type}`;
    
    if (type === 'success') {
        const booking = data.booking;
        resultContent.innerHTML = `
            <div class="booking-details">
                <h4>Booking Verified Successfully!</h4>
                <div class="detail-row">
                    <span class="detail-label">Booking ID:</span>
                    <span>${booking.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span>${booking.user.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Beach:</span>
                    <span>${booking.beach.title}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span>${booking.booking_date}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span>${booking.status}</span>
                </div>
            </div>
            <button onclick="checkInBooking('${data.booking.token.key}')" class="btn btn-success">
                Check In Booking
            </button>
        `;
    } else {
        resultContent.innerHTML = `
            <p><strong>Error:</strong> ${data.message}</p>
        `;
    }
    
    resultSection.style.display = 'block';
}

// Check in booking
async function checkInBooking(token) {
    try {
        const response = await fetch(`/api/v1/bookings/verify/${token}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            alert('Booking checked in successfully!');
            resultSection.style.display = 'none';
            tokenInput.value = '';
        } else {
            alert('Error checking in booking: ' + data.message);
        }
    } catch (err) {
        alert('Error checking in booking: ' + err.message);
    }
}

// QR Code scanning (basic implementation)
// Note: For production, you'd want to use a proper QR code library like jsQR
function scanQRCode() {
    // This is a placeholder for QR code scanning
    // In production, you'd implement actual QR code detection
    console.log('QR code scanning would be implemented here');
}
</script>
{% endblock %} 